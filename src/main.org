#+TITLE: Main file
#+PROPERTY: header-args :tangle yes

* Welcome to org-kernel
This is a kernel written in org.

* Code
** Includes
Includes the required files.
#+BEGIN_SRC c
  #include <stdint.h>
  #include <stddef.h>
  #include <stivale2.h>
#+END_SRC

** Stivale tags
Sets up the proper tags to get from the stivale boot protocol.
 #+BEGIN_SRC c
   static uint8_t stack[4096];
   static struct stivale2_header_tag_terminal terminal_hdr_tag = {
       .tag = {
           .identifier = STIVALE2_HEADER_TAG_TERMINAL_ID,
           .next = 0
       },

       .flags = 0
   };
   
   static struct stivale2_header_tag_framebuffer framebuffer_hdr_tag = {
       .tag = {
           .identifier = STIVALE2_HEADER_TAG_FRAMEBUFFER_ID,

           .next = (uint64_t)&terminal_hdr_tag
       },

       .framebuffer_width  = 0,
       .framebuffer_height = 0,
       .framebuffer_bpp    = 0
   };
   
   __attribute__((section(".stivale2hdr"), used))
   static struct stivale2_header stivale_hdr = {

       .entry_point = 0,

       .stack = (uintptr_t)stack + sizeof(stack),
 
       .flags = (1 << 1) | (1 << 2),

       .tags = (uintptr_t)&framebuffer_hdr_tag
   };
   
   #+END_SRC
The following function will allow us to scan for tags that we want

#+BEGIN_SRC c
    // We will now write a helper function which will allow us to scan for tags
    // that we want FROM the bootloader (structure tags).
    void *stivale2_get_tag(struct stivale2_struct *stivale2_struct, uint64_t id) {
        struct stivale2_tag *current_tag = (void *)stivale2_struct->tags;
        for (;;) {
            // If the tag pointer is NULL (end of linked list), we did not find
            // the tag. Return NULL to signal this.
            if (current_tag == NULL) {
                return NULL;
            }
  
            // Check whether the identifier matches. If it does, return a pointer
            // to the matching tag.
            if (current_tag->identifier == id) {
                return current_tag;
            }
  
            // Get a pointer to the next tag in the linked list and repeat.
            current_tag = (void *)current_tag->next;
        }
    }
#+END_SRC

** Main function
This is our kernel's entry point
#+BEGIN_SRC c
     void _start(struct stivale2_struct *stivale2_struct) {
        struct stivale2_struct_tag_terminal *term_str_tag;
        term_str_tag = stivale2_get_tag(stivale2_struct, STIVALE2_STRUCT_TAG_TERMINAL_ID);
  
        if (!term_str_tag) {
            for (;;) {
                __asm__ volatile("hlt");
            }
        }
  
        void *term_write_ptr = (void *)term_str_tag->term_write;
  
        void (*term_write)(const char *string, size_t length) = term_write_ptr;
 
        term_write("Welcome to org-kernel", 21);
  
        for (;;) {
            __asm__("hlt");
        }
    }
#+END_SRC
